<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trading Pro: Active Orders</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .input-dark { background-color: #1e293b; border: 1px solid #334155; color: white; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .tab-inactive { color: #64748b; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
    </style>
</head>
<body class="min-h-screen pb-24">

    <!-- CONFIG -->
    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzG8-PLk0GEGtV7nPsi9bBpTlSTcDeCHt-B-xivGeiKRXHhDHzaWFFYQmD3sDrQIJ64Ng/exec'; 
    </script>

    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-40 glass shadow-lg">
        <div class="max-w-lg mx-auto px-4">
            <div class="flex justify-between items-center h-14">
                <span class="font-bold text-lg text-blue-400">Trading Journal</span>
                <button onclick="fetchData()" class="text-xs bg-slate-700 px-3 py-1 rounded-full"><i class="fa-solid fa-rotate"></i></button>
            </div>
            <div class="flex border-b border-slate-700 text-sm">
                <button onclick="switchTab('record')" id="tab-record" class="flex-1 py-3 tab-active">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
                <button onclick="switchTab('active')" id="tab-active" class="flex-1 py-3 tab-inactive relative">
                    ‡∏ñ‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà <span id="badge-active" class="ml-1 bg-red-500 text-white text-[10px] px-1.5 rounded-full hidden">0</span>
                </button>
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="flex-1 py-3 tab-inactive">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
            </div>
        </div>
    </nav>

    <div class="max-w-lg mx-auto mt-28 px-4">

        <!-- TAB 1: RECORD NEW ORDER -->
        <div id="view-record" class="animate-fade-in">
            <form id="createForm" class="space-y-4">
                <div class="glass rounded-xl p-4 space-y-3">
                    <h3 class="text-sm text-blue-400 font-bold"><i class="fa-solid fa-plus-circle"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà</h3>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <select name="Pair" class="input-dark w-full rounded p-2">
                            <option value="XAUUSD">XAUUSD</option>
                            <option value="EURUSD">EURUSD</option>
                            <option value="USDJPY">USDJPY</option>
                            <option value="BTCUSD">BTCUSD</option>
                        </select>
                        <input type="number" step="0.01" name="Lot" placeholder="Lot 0.01" class="input-dark w-full rounded p-2 text-center" required>
                    </div>

                    <div class="flex space-x-2">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="Position" value="BUY" class="peer hidden" checked>
                            <div class="p-2 rounded bg-slate-800 border border-slate-700 text-center peer-checked:bg-green-600 font-bold text-sm">BUY</div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="Position" value="SELL" class="peer hidden">
                            <div class="p-2 rounded bg-slate-800 border border-slate-700 text-center peer-checked:bg-red-600 font-bold text-sm">SELL</div>
                        </label>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs text-slate-400">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (Entry)</label>
                            <input type="number" step="0.01" name="Entry" placeholder="Price" class="input-dark w-full rounded p-2 text-center" required>
                        </div>
                        <div>
                             <!-- Hidden Exit for New Order -->
                             <label class="text-xs text-slate-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                             <div class="text-sm py-2 text-yellow-400 font-bold text-center border border-slate-700 rounded bg-slate-800">
                                 RUNNING ‚è≥
                             </div>
                        </div>
                    </div>
                </div>
                
                <!-- Checklist -->
                <div class="glass rounded-xl p-4 border-l-4 border-blue-500 text-sm space-y-2">
                    <p class="text-xs text-slate-400 mb-2">Checklist ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤:</p>
                    <label class="flex items-center space-x-2"><input type="checkbox" name="H1 Trend" value="Yes" class="rounded bg-slate-700"> <span>H1 Trend ‡∏ï‡∏£‡∏á</span></label>
                    <label class="flex items-center space-x-2"><input type="checkbox" name="M15 Signal" value="Yes" class="rounded bg-slate-700"> <span>EMA M15 ‡∏ï‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß</span></label>
                    <label class="flex items-center space-x-2"><input type="checkbox" name="ADX > 20" value="Yes" class="rounded bg-slate-700"> <span>ADX > 20</span></label>
                    <label class="flex items-center space-x-2"><input type="checkbox" name="Retest" value="Yes" class="rounded bg-slate-700"> <span>Retest & Trigger</span></label>
                </div>

                <input type="hidden" name="action" value="create">
                <input type="hidden" name="Result" value="RUNNING">
                <input type="hidden" name="Date" id="dateField">
                <input type="hidden" name="Time" id="timeField">

                <button type="submit" id="btnCreate" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (RUNNING)
                </button>
            </form>
        </div>

        <!-- TAB 2: ACTIVE ORDERS -->
        <div id="view-active" class="hidden animate-fade-in space-y-3">
            <div id="active-list" class="pb-10">
                <!-- Orders will appear here -->
                <div class="text-center text-slate-500 mt-10"><i class="fa-solid fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
        </div>

        <!-- TAB 3: DASHBOARD (Summary) -->
        <div id="view-dashboard" class="hidden animate-fade-in space-y-4">
             <div class="grid grid-cols-2 gap-3">
                <div class="glass rounded-xl p-4 text-center border-b-4 border-green-500">
                    <p class="text-xs text-slate-400">WIN RATE</p>
                    <h2 id="dash-winrate" class="text-2xl font-bold text-white">--%</h2>
                </div>
                <div class="glass rounded-xl p-4 text-center border-b-4 border-blue-500">
                    <p class="text-xs text-slate-400">NET PROFIT</p>
                    <h2 id="dash-profit" class="text-2xl font-bold text-white">--</h2>
                </div>
            </div>
            <div class="glass rounded-xl p-3">
                <h3 class="text-sm font-bold mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Closed)</h3>
                <div id="closed-history" class="text-xs space-y-2"></div>
            </div>
        </div>

    </div>

    <!-- MODAL: CLOSE ORDER -->
    <div id="closeModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-80 px-4">
        <div class="bg-slate-800 rounded-xl w-full max-w-sm p-5 border border-slate-600 shadow-2xl transform transition-all scale-100">
            <h3 class="text-lg font-bold text-white mb-4">‡∏õ‡∏¥‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: <span id="modalPair" class="text-blue-400"></span></h3>
            
            <form id="closeForm" class="space-y-4">
                <input type="hidden" name="action" value="update">
                <input type="hidden" name="id" id="modalId">
                <input type="hidden" id="modalEntry">
                <input type="hidden" id="modalLot">
                <input type="hidden" id="modalPos">

                <div>
                    <label class="text-xs text-slate-400">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏¥‡∏î (Exit Price)</label>
                    <input type="number" step="0.01" name="Exit" id="modalExit" class="input-dark w-full rounded p-3 text-lg text-center font-bold text-yellow-400" required oninput="calcModalPL()">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-slate-400">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</label>
                        <select name="Result" id="modalResult" class="input-dark w-full rounded p-2 text-sm">
                            <option value="WIN">WIN ‚úÖ</option>
                            <option value="LOSS">LOSS ‚ùå</option>
                            <option value="BE">BE ‚öñÔ∏è</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô ($)</label>
                        <input type="number" step="0.01" name="P/L ($)" id="modalPL" class="input-dark w-full rounded p-2 text-right font-bold" required>
                    </div>
                </div>

                <div>
                    <label class="text-xs text-slate-400">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡πà‡∏á‡∏ó‡πâ‡∏≤‡∏¢</label>
                    <input type="text" name="Notes" placeholder="‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î..." class="input-dark w-full rounded p-2 text-sm">
                </div>

                <div class="flex space-x-3 pt-2">
                    <button type="button" onclick="closeModal()" class="flex-1 py-3 rounded-lg bg-slate-700 text-slate-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" id="btnCloseConfirm" class="flex-1 py-3 rounded-lg bg-green-600 text-white font-bold shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î</button>
                </div>
            </form>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-slate-800 border border-slate-600 px-6 py-3 rounded-full shadow-2xl text-sm transition-all duration-300 translate-y-20 opacity-0 z-50 whitespace-nowrap"></div>

    <script>
        // --- LOGIC ---
        let allData = []; // Store fetched data

        function switchTab(tab) {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.className = "flex-1 py-3 tab-inactive relative");
            
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            const activeTabBtn = document.getElementById(`tab-${tab}`);
            activeTabBtn.className = "flex-1 py-3 tab-active relative";
            
            // Re-attach badge
            const badge = document.getElementById('badge-active');
            document.getElementById('tab-active').appendChild(badge);

            if(tab === 'active' || tab === 'dashboard') fetchData();
        }

        // Fetch Data & Render
        function fetchData() {
            if(!scriptURL || scriptURL.includes('‡∏ß‡∏≤‡∏á_URL')) {
                showToast('‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà URL Script');
                return;
            }

            document.getElementById('active-list').innerHTML = '<div class="text-center text-slate-500 mt-5"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</div>';

            fetch(scriptURL)
            .then(res => res.json())
            .then(data => {
                // Data format: [[Header], [Row1], [Row2]]
                // Map headers to make it easier
                const headers = data[0];
                const rows = data.slice(1).map(row => {
                    let obj = {};
                    headers.forEach((h, i) => obj[h] = row[i]);
                    return obj;
                });
                
                allData = rows;
                renderActiveOrders(rows);
                renderDashboard(rows);
            })
            .catch(err => {
                console.error(err);
                document.getElementById('active-list').innerHTML = '<div class="text-center text-red-400 mt-5">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
            });
        }

        function renderActiveOrders(rows) {
            const activeContainer = document.getElementById('active-list');
            // Filter: Result contains 'RUNNING' or Exit is empty
            const active = rows.filter(r => r.Result === 'RUNNING' || r.Exit === '');
            
            // Update Badge
            const badge = document.getElementById('badge-active');
            if(active.length > 0) {
                badge.innerText = active.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            if(active.length === 0) {
                activeContainer.innerHTML = `
                    <div class="text-center mt-10 opacity-50">
                        <i class="fa-solid fa-box-open text-4xl mb-3"></i>
                        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á (‡∏ß‡πà‡∏≤‡∏á‡∏á‡∏≤‡∏ô)</p>
                    </div>`;
                return;
            }

            let html = '';
            // Sort active by Date desc (newest first)
            active.reverse().forEach(item => {
                const isBuy = item.Position === 'BUY';
                const colorClass = isBuy ? 'text-green-400' : 'text-red-400';
                const bgClass = isBuy ? 'bg-green-900/20 border-green-800' : 'bg-red-900/20 border-red-800';
                
                // Format Date
                let dateStr = item.Date;
                if(typeof item.Date === 'string' && item.Date.includes('T')) {
                    dateStr = new Date(item.Date).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
                }

                html += `
                <div class="glass p-4 rounded-xl mb-3 border ${bgClass} flex justify-between items-center">
                    <div>
                        <div class="flex items-center space-x-2">
                            <span class="font-bold text-lg">${item.Pair}</span>
                            <span class="text-xs px-2 py-0.5 rounded bg-slate-700 ${colorClass}">${item.Position} ${item.Lot}</span>
                        </div>
                        <div class="text-xs text-slate-400 mt-1">
                            Entry: <span class="text-white">${item.Entry}</span> | Time: ${dateStr}
                        </div>
                    </div>
                    <button onclick="openCloseModal('${item.ID}', '${item.Pair}', '${item.Position}', '${item.Lot}', '${item.Entry}')" 
                        class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition">
                        Close
                    </button>
                </div>`;
            });
            activeContainer.innerHTML = html;
        }

        function renderDashboard(rows) {
            const closed = rows.filter(r => r.Result === 'WIN' || r.Result === 'LOSS' || r.Result === 'BE');
            
            let totalPL = 0;
            let wins = 0;
            
            closed.forEach(r => {
                totalPL += parseFloat(r['P/L ($)'] || 0);
                if(r.Result === 'WIN') wins++;
            });

            const winRate = closed.length > 0 ? ((wins / closed.length) * 100).toFixed(0) : 0;
            
            document.getElementById('dash-winrate').innerText = `${winRate}%`;
            document.getElementById('dash-winrate').className = `text-2xl font-bold ${winRate >= 50 ? 'text-green-400' : 'text-red-400'}`;
            
            document.getElementById('dash-profit').innerText = `$${totalPL.toFixed(2)}`;
            document.getElementById('dash-profit').className = `text-2xl font-bold ${totalPL >= 0 ? 'text-blue-400' : 'text-red-400'}`;

            // History List
            let histHtml = '';
            closed.slice(-5).reverse().forEach(r => {
                const pl = parseFloat(r['P/L ($)'] || 0);
                histHtml += `
                <div class="flex justify-between border-b border-slate-700 pb-1 mb-1 last:border-0">
                    <span>${r.Pair} (${r.Position})</span>
                    <span class="${pl >= 0 ? 'text-green-400':'text-red-400'} font-bold">${pl > 0 ? '+':''}${pl.toFixed(2)}$</span>
                </div>`;
            });
            document.getElementById('closed-history').innerHTML = histHtml || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥';
        }

        // --- CREATE ORDER ---
        document.getElementById('createForm').addEventListener('submit', e => {
            e.preventDefault();
            const btn = document.getElementById('btnCreate');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
            btn.disabled = true;

            const now = new Date();
            document.getElementById('dateField').value = now.toLocaleDateString('th-TH');
            document.getElementById('timeField').value = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

            const formData = new FormData(e.target);
            const data = {};
            formData.forEach((val, key) => data[key] = val);
            
            // Checkbox defaults
            ['H1 Trend', 'M15 Signal', 'ADX > 20', 'Retest'].forEach(k => {
                if(!data[k]) data[k] = 'No';
            });

            fetch(scriptURL, { method: 'POST', body: JSON.stringify(data) })
            .then(res => res.json())
            .then(res => {
                if(res.result === 'success') {
                    showToast('‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (Running)');
                    e.target.reset();
                    switchTab('active'); // Auto jump to active tab
                } else {
                    showToast('‚ùå Error: ' + JSON.stringify(res));
                }
            })
            .catch(err => showToast('‚ùå Connection Error'))
            .finally(() => {
                btn.innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (RUNNING)';
                btn.disabled = false;
            });
        });

        // --- CLOSE MODAL LOGIC ---
        const modal = document.getElementById('closeModal');
        
        function openCloseModal(id, pair, pos, lot, entry) {
            document.getElementById('modalId').value = id;
            document.getElementById('modalPair').innerText = pair;
            document.getElementById('modalEntry').value = entry;
            document.getElementById('modalLot').value = lot;
            document.getElementById('modalPos').value = pos;
            
            document.getElementById('modalExit').value = '';
            document.getElementById('modalPL').value = '';
            document.getElementById('modalResult').value = 'WIN';
            
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        function calcModalPL() {
            const entry = parseFloat(document.getElementById('modalEntry').value);
            const exit = parseFloat(document.getElementById('modalExit').value);
            const lot = parseFloat(document.getElementById('modalLot').value);
            const pos = document.getElementById('modalPos').value;
            const pair = document.getElementById('modalPair').innerText;

            if(!exit) return;

            let diff = (pos === 'BUY') ? (exit - entry) : (entry - exit);
            let multiplier = pair.includes('JPY') ? 1000 : (pair.includes('XAU') ? 100 : 100000);
            
            let profit = diff * lot * multiplier;
            document.getElementById('modalPL').value = profit.toFixed(2);
            
            // Auto select Result
            const resSelect = document.getElementById('modalResult');
            const plInput = document.getElementById('modalPL');
            
            if(profit > 0) {
                resSelect.value = 'WIN';
                plInput.style.color = '#4ade80';
            } else if(profit < 0) {
                resSelect.value = 'LOSS';
                plInput.style.color = '#f87171';
            } else {
                resSelect.value = 'BE';
                plInput.style.color = 'white';
            }
        }

        // --- SUBMIT CLOSE ORDER ---
        document.getElementById('closeForm').addEventListener('submit', e => {
            e.preventDefault();
            const btn = document.getElementById('btnCloseConfirm');
            btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î...';
            btn.disabled = true;

            const formData = new FormData(e.target);
            const data = {};
            formData.forEach((val, key) => data[key] = val);

            fetch(scriptURL, { method: 'POST', body: JSON.stringify(data) })
            .then(res => res.json())
            .then(res => {
                if(res.result === 'updated') {
                    showToast('üí∞ ‡∏õ‡∏¥‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
                    closeModal();
                    fetchData(); // Refresh list
                } else {
                    showToast('‚ùå Error Closing Order');
                }
            })
            .catch(err => showToast('‚ùå Connection Error'))
            .finally(() => {
                btn.innerText = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î';
                btn.disabled = false;
            });
        });

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        // Init Load
        if(scriptURL && !scriptURL.includes('‡∏ß‡∏≤‡∏á_URL')) fetchData();
    </script>
</body>
</html>

