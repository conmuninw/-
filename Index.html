<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Trading Mentor v4.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #050810;
            --card-bg: rgba(15, 23, 42, 0.6);
            --accent-blue: #38bdf8;
            --accent-purple: #818cf8;
            --success: #10b981;
            --danger: #f43f5e;
        }
        body { 
            font-family: 'Plus Jakarta Sans', 'Sarabun', sans-serif; 
            background-color: var(--bg-dark); 
            color: #f8fafc;
            background-image: radial-gradient(circle at 50% -20%, #1e293b 0%, #050810 80%);
            min-height: 100vh;
        }
        .glass-card { 
            background: var(--card-bg); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
        }
        .input-style {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            color: white;
            transition: all 0.3s;
        }
        .btn-gradient {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            box-shadow: 0 10px 15px -3px rgba(56, 189, 248, 0.3);
        }
        .tab-content { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .checkbox-custom { width: 1.2rem; height: 1.2rem; border-radius: 6px; border: 2px solid #334155; appearance: none; cursor: pointer; position: relative; transition: all 0.2s; }
        .checkbox-custom:checked { background-color: var(--accent-blue); border-color: var(--accent-blue); }
        .checkbox-custom:checked::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: white; font-size: 0.7rem; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .detail-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body class="pb-24">

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyncps3larhrUUDtCWP_C0AXB1PR3oAO9TgFFwLgN9wqYNIA1Sg021XiP2CDBfrjaoz/exec'; 
        let submitted = false;
        let allData = [];
        let equityChart = null;
    </script>

    <iframe name="hidden_iframe" style="display:none;" onload="if(submitted) handleFormResponse();"></iframe>

    <header class="p-6 flex justify-between items-center sticky top-0 z-40 backdrop-blur-md">
        <div>
            <p class="text-[10px] font-bold text-sky-400 uppercase tracking-[0.2em]">Personal Mentor</p>
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">TradeMaster <span class="text-sky-400">v4.2</span></h1>
        </div>
        <div class="flex gap-3">
            <button onclick="fetchData()" class="w-10 h-10 rounded-2xl glass-card flex items-center justify-center text-slate-400 hover:text-white transition">
                <i class="fa-solid fa-arrows-rotate text-sm"></i>
            </button>
        </div>
    </header>

    <main class="px-6 max-w-lg mx-auto">
        
        <!-- VIEW: RECORD -->
        <section id="view-record" class="tab-content space-y-5">
            <div class="glass-card p-2 flex gap-1">
                <div class="flex-1 py-3 px-4 rounded-xl bg-blue-500/10 border border-blue-500/20">
                    <p class="text-[9px] font-bold text-blue-400 uppercase mb-1">Lot ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</p>
                    <p id="rec-lot" class="text-lg font-bold text-white">0.01 <span class="text-[10px] font-normal opacity-60">LOT</span></p>
                </div>
                <div class="flex-1 py-3 px-4 rounded-xl bg-purple-500/10 border border-purple-500/20 text-right">
                    <p class="text-[9px] font-bold text-purple-400 uppercase mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ($)</p>
                    <p id="max-risk" class="text-lg font-bold text-white">$2.00</p>
                </div>
            </div>

            <form id="recordForm" action="" method="POST" target="hidden_iframe" onsubmit="submitted=true; prepareSubmit('create');">
                <input type="hidden" name="action" value="create">
                <input type="hidden" name="ID" id="input-id">
                <input type="hidden" name="Date" id="input-date">
                <input type="hidden" name="Time" id="input-time">
                <input type="hidden" name="Result" value="RUNNING">

                <div class="glass-card p-6 space-y-6">
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">‡∏Ñ‡∏π‡πà‡πÄ‡∏á‡∏¥‡∏ô/‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</label>
                            <select name="Pair" class="input-style w-full p-3 font-bold appearance-none">
                                <option value="XAUUSD">GOLD (XAUUSD)</option>
                                <option value="EURUSD">EURUSD</option>
                                <option value="GBPUSD">GBPUSD</option>
                                <option value="USDJPY">USDJPY</option>
                            </select>
                        </div>
                        <div class="w-28">
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Lot</label>
                            <input type="number" step="0.01" name="Lot" value="0.01" class="input-style w-full p-3 text-center font-bold">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 p-1 bg-slate-900/50 rounded-2xl">
                        <label class="cursor-pointer">
                            <input type="radio" name="Position" value="BUY" checked class="hidden peer">
                            <div class="py-3 text-center rounded-xl peer-checked:bg-emerald-500 peer-checked:text-white text-slate-500 font-bold transition-all">BUY</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="Position" value="SELL" class="hidden peer">
                            <div class="py-3 text-center rounded-xl peer-checked:bg-rose-500 peer-checked:text-white text-slate-500 font-bold transition-all">SELL</div>
                        </label>
                    </div>

                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block text-center">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (Entry)</label>
                        <input type="number" step="0.00001" name="Entry" placeholder="0.00000" class="input-style w-full p-4 text-2xl font-mono text-center tracking-wider text-sky-400" required>
                    </div>
                </div>

                <div class="mt-5 glass-card p-6 border-t-4 border-sky-500">
                    <div class="flex items-center gap-2 mb-4">
                        <i class="fa-solid fa-shield-check text-sky-500"></i>
                        <h3 class="text-xs font-bold uppercase tracking-widest">‡πÄ‡∏ä‡πá‡∏Ñ‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</h3>
                    </div>
                    <div class="space-y-3">
                        <label class="flex items-center justify-between p-4 bg-slate-900/30 rounded-2xl border border-white/5 cursor-pointer hover:bg-slate-800 transition">
                            <span class="text-xs text-slate-300">‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡πå H1 ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á (EMA 50)</span>
                            <input type="checkbox" name="H1 Trend" value="Yes" class="checkbox-custom">
                        </label>
                        <label class="flex items-center justify-between p-4 bg-slate-900/30 rounded-2xl border border-white/5 cursor-pointer hover:bg-slate-800 transition">
                            <span class="text-xs text-slate-300">M15 EMA 8/21 ‡∏ï‡∏±‡∏î‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
                            <input type="checkbox" name="M15 Signal" value="Yes" class="checkbox-custom">
                        </label>
                        <label class="flex items-center justify-between p-4 bg-slate-900/30 rounded-2xl border border-white/5 cursor-pointer hover:bg-slate-800 transition">
                            <span class="text-xs text-slate-300">ADX > 20 ‡∏°‡∏µ‡πÅ‡∏£‡∏á‡∏™‡πà‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</span>
                            <input type="checkbox" name="ADX > 20" value="Yes" class="checkbox-custom">
                        </label>
                    </div>
                </div>

                <div class="mt-5 glass-card p-6">
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-3 block">‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏à‡∏¥‡∏ï‡πÉ‡∏à‡∏ï‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ó‡∏£‡∏î</label>
                    <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                        <label class="shrink-0 cursor-pointer">
                            <input type="radio" name="Emotion" value="‡∏õ‡∏Å‡∏ï‡∏¥" checked class="hidden peer">
                            <div class="px-4 py-2 rounded-full border border-white/10 text-[11px] peer-checked:bg-white peer-checked:text-black transition">üòê ‡∏õ‡∏Å‡∏ï‡∏¥</div>
                        </label>
                        <label class="shrink-0 cursor-pointer">
                            <input type="radio" name="Emotion" value="FOMO" class="hidden peer">
                            <div class="px-4 py-2 rounded-full border border-white/10 text-[11px] peer-checked:bg-amber-500 peer-checked:text-white transition">üò® ‡∏Å‡∏•‡∏±‡∏ß‡∏ï‡∏Å‡∏£‡∏ñ (FOMO)</div>
                        </label>
                        <label class="shrink-0 cursor-pointer">
                            <input type="radio" name="Emotion" value="‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÄ‡∏Å‡∏¥‡∏ô" class="hidden peer">
                            <div class="px-4 py-2 rounded-full border border-white/10 text-[11px] peer-checked:bg-purple-500 peer-checked:text-white transition">ü§ë ‡πÇ‡∏•‡∏†/‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÄ‡∏Å‡∏¥‡∏ô</div>
                        </label>
                        <label class="shrink-0 cursor-pointer">
                            <input type="radio" name="Emotion" value="‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏∑‡∏ô" class="hidden peer">
                            <div class="px-4 py-2 rounded-full border border-white/10 text-[11px] peer-checked:bg-rose-500 peer-checked:text-white transition">üî• ‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏∑‡∏ô</div>
                        </label>
                    </div>
                    <textarea name="Notes" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå..." class="input-style w-full p-4 text-sm h-24 resize-none"></textarea>
                </div>

                <button type="submit" id="btn-submit" class="w-full mt-6 py-5 btn-gradient rounded-3xl font-bold text-white text-lg transition-all active:scale-[0.98]">
                    ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
                </button>
            </form>
        </section>

        <!-- VIEW: DASHBOARD -->
        <section id="view-stats" class="tab-content hidden space-y-5">
            <div class="glass-card p-6 relative overflow-hidden">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°</p>
                <h2 id="balance-val" class="text-4xl font-bold text-white mb-4">$10.00</h2>
                <div class="h-32 w-full">
                    <canvas id="equityChart"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="glass-card p-5 text-center">
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-1">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ä‡∏ô‡∏∞</p>
                    <p id="winrate-val" class="text-2xl font-bold text-sky-400">0%</p>
                </div>
                <div class="glass-card p-5 text-center">
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-1">‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>
                    <p id="avg-profit-val" class="text-2xl font-bold text-emerald-400">+$0.00</p>
                </div>
            </div>

            <div class="glass-card p-6 border-l-4 border-indigo-500">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-2xl bg-indigo-500/20 flex items-center justify-center text-indigo-400">
                        <i class="fa-solid fa-brain"></i>
                    </div>
                    <h3 class="text-sm font-bold">‡∏ö‡∏ó‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å Mentor</h3>
                </div>
                <div id="mentor-advice" class="space-y-4"></div>
            </div>

            <div class="flex items-center justify-between px-2">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ 5 ‡πÑ‡∏°‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π)</h3>
            </div>
            <div id="history-list" class="space-y-3 pb-10"></div>
        </section>

        <!-- VIEW: ACTIVE -->
        <section id="view-active" class="tab-content hidden space-y-4">
            <div id="active-list" class="space-y-4"></div>
        </section>

    </main>

    <!-- Navigation -->
    <nav class="fixed bottom-6 left-6 right-6 h-20 glass-card z-50 flex justify-around items-center px-4 shadow-2xl">
        <button onclick="switchView('record')" id="nav-record" class="nav-item flex flex-col items-center gap-1 text-sky-500">
            <i class="fa-solid fa-plus-circle text-2xl"></i>
            <span class="text-[9px] font-bold uppercase">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
        </button>
        <button onclick="switchView('active')" id="nav-active" class="nav-item flex flex-col items-center gap-1 text-slate-500">
            <div class="relative">
                <i class="fa-solid fa-layer-group text-2xl"></i>
                <span id="badge-count" class="absolute -top-1 -right-2 bg-rose-500 text-white text-[8px] w-4 h-4 rounded-full hidden flex items-center justify-center">0</span>
            </div>
            <span class="text-[9px] font-bold uppercase">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á</span>
        </button>
        <button onclick="switchView('stats')" id="nav-stats" class="nav-item flex flex-col items-center gap-1 text-slate-500">
            <i class="fa-solid fa-chart-pie text-2xl"></i>
            <span class="text-[9px] font-bold uppercase">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span>
        </button>
    </nav>

    <!-- Modal: Trade Detail Inspector (New!) -->
    <div id="modal-detail" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-6 bg-black/90 backdrop-blur-xl">
        <div class="glass-card w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-300 border-sky-500/30">
            <div class="p-6 border-b border-white/5 flex justify-between items-center bg-sky-500/5">
                <div>
                    <h3 class="font-bold text-lg" id="det-pair">---</h3>
                    <p class="text-[9px] text-slate-500 uppercase tracking-widest" id="det-id">---</p>
                </div>
                <button onclick="closeDetail()" class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 space-y-2 max-h-[70vh] overflow-y-auto" id="det-content">
                <!-- Details injected here -->
            </div>
        </div>
    </div>

    <!-- Modal: Close Position -->
    <div id="modal-close" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-6 bg-black/80 backdrop-blur-md">
        <div class="glass-card w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-300">
            <div class="p-6 border-b border-white/5 flex justify-between items-center">
                <h3 class="font-bold text-lg">‡∏õ‡∏¥‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h3>
                <button onclick="closeModal()" class="text-slate-500"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 space-y-5">
                <form id="closeForm" action="" method="POST" target="hidden_iframe" onsubmit="submitted=true;">
                    <input type="hidden" name="action" value="update">
                    <input type="hidden" name="id" id="close-id">
                    <input type="hidden" name="Result" id="close-result">
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î (Exit)</label>
                            <input type="number" step="0.00001" name="Exit" id="exit-price" class="input-style w-full p-4 text-xl font-mono text-center text-amber-400" required>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-slate-900/50 rounded-2xl">
                            <span class="text-xs font-bold text-slate-400">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                            <input type="text" name="P/L ($)" id="pl-display" class="bg-transparent text-right font-bold text-lg outline-none w-24" readonly>
                        </div>
                        <textarea name="Review" placeholder="‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πâ‡∏ô‡∏µ‡πâ..." class="input-style w-full p-4 text-sm h-24 resize-none"></textarea>
                    </div>
                    <button type="submit" class="w-full mt-6 py-4 bg-white text-black font-bold rounded-2xl">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="toast" class="fixed top-8 left-1/2 -translate-x-1/2 glass-card px-6 py-4 flex items-center gap-3 transition-all duration-500 -translate-y-32 z-[100]">
        <div class="w-8 h-8 rounded-full bg-sky-500/20 flex items-center justify-center text-sky-500"><i class="fa-solid fa-check"></i></div>
        <span id="toast-msg" class="text-sm font-bold">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
    </div>

    <script>
        const START_BALANCE = 10.0;

        function switchView(view) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('text-sky-500');
                b.classList.add('text-slate-500');
            });
            document.getElementById(`nav-${view}`).classList.remove('text-slate-500');
            document.getElementById(`nav-${view}`).classList.add('text-sky-500');
            if (view === 'stats') renderChart();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('-translate-y-32');
            setTimeout(() => t.classList.add('-translate-y-32'), 3000);
        }

        function prepareSubmit(action) {
            if (action === 'create') {
                const now = new Date();
                document.getElementById('input-id').value = 'TRD-' + Date.now();
                document.getElementById('input-date').value = now.toLocaleDateString('th-TH');
                document.getElementById('input-time').value = now.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
                document.getElementById('btn-submit').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
            }
        }

        function handleFormResponse() {
            if (submitted) {
                showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                submitted = false;
                document.getElementById('recordForm').reset();
                document.getElementById('btn-submit').innerText = '‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå';
                closeModal();
                fetchData();
            }
        }

        function fetchData() {
            if (!scriptURL || scriptURL.includes('URL')) return;
            fetch(scriptURL).then(r => r.json()).then(data => {
                const headers = data[0];
                allData = data.slice(1).map(row => {
                    let o = {}; headers.forEach((h, i) => o[h] = row[i]); return o;
                });
                processAnalysis();
                renderActive();
                renderHistory();
            });
        }

        function processAnalysis() {
            const closed = allData.filter(d => d.Result !== 'RUNNING');
            let totalPL = 0; let wins = 0;
            closed.forEach(d => {
                const pl = parseFloat(d['P/L ($)'] || 0);
                totalPL += pl; if (d.Result === 'WIN') wins++;
            });
            const bal = START_BALANCE + totalPL;
            document.getElementById('balance-val').innerText = `$${bal.toFixed(2)}`;
            document.getElementById('winrate-val').innerText = closed.length ? Math.round((wins / closed.length) * 100) + '%' : '0%';
            document.getElementById('avg-profit-val').innerText = closed.length ? (totalPL / closed.length >= 0 ? '+' : '') + `$${(totalPL / closed.length).toFixed(2)}` : '$0.00';
            document.getElementById('rec-lot').innerText = `${Math.max(0.01, (bal / 15 * 0.01)).toFixed(2)} LOT`;
            document.getElementById('max-risk').innerText = `$${(bal * 0.2).toFixed(2)}`;
            generateAIAdvice(closed);
        }

        function generateAIAdvice(closed) {
            const container = document.getElementById('mentor-advice');
            if (closed.length < 3) {
                container.innerHTML = `<div class="p-4 bg-slate-900/50 rounded-2xl text-xs text-slate-400">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ 3 ‡πÑ‡∏°‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</div>`;
                return;
            }
            const stats = { fomo: closed.filter(d => d.Emotion === 'FOMO').length, noM15: closed.filter(d => d['M15 Signal'] !== 'Yes').length };
            let html = '';
            if (stats.fomo > 0) {
                html += `<div class="p-4 bg-rose-500/10 border border-rose-500/20 rounded-2xl text-xs"><p class="font-bold text-rose-400 mb-1">üö® ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ï‡∏¥</p>‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ó‡∏£‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå FOMO ‡∏ö‡πà‡∏≠‡∏¢ (${stats.fomo} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á) ‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏±‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div>`;
            }
            if (stats.noM15 > 0) {
                html += `<div class="p-4 bg-amber-500/10 border border-amber-500/20 rounded-2xl text-xs mt-2"><p class="font-bold text-amber-400 mb-1">üõ† ‡∏à‡∏∏‡∏î‡∏ö‡∏≠‡∏î‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</p>‡∏Ñ‡∏∏‡∏ì‡∏•‡∏∑‡∏°‡∏£‡∏≠ EMA M15 ‡∏ï‡∏±‡∏î‡∏Å‡∏±‡∏ô‡∏ö‡πà‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏≠‡∏î‡∏ó‡∏ô‡∏£‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏ô‡∏•‡∏≤‡∏Å</div>`;
            }
            container.innerHTML = html || '<p class="text-xs text-slate-400">‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡∏Ñ‡∏£‡∏±‡∏ö</p>';
        }

        function renderActive() {
            const list = document.getElementById('active-list');
            const active = allData.filter(d => d.Result === 'RUNNING');
            document.getElementById('badge-count').innerText = active.length;
            document.getElementById('badge-count').classList.toggle('hidden', active.length === 0);
            list.innerHTML = active.map(d => `
                <div onclick='openCloseModal(${JSON.stringify(d)})' class="glass-card p-5 border-l-4 ${d.Position==='BUY'?'border-emerald-500':'border-rose-500'} active:scale-95 transition">
                    <div class="flex justify-between items-center">
                        <div><h4 class="font-bold">${d.Pair}</h4><p class="text-[10px] text-slate-500">${d.Date} ${d.Time}</p></div>
                        <div class="text-right">
                            <span class="px-2 py-1 rounded-lg text-[10px] font-bold ${d.Position==='BUY'?'bg-emerald-500/20 text-emerald-400':'bg-rose-500/20 text-rose-400'}">${d.Position}</span>
                            <p class="text-xs font-mono mt-1">${d.Lot}L @ ${d.Entry}</p>
                        </div>
                    </div>
                </div>
            `).join('') || `<div class="p-12 text-center text-slate-600">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á</div>`;
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            const history = allData.filter(d => d.Result !== 'RUNNING').reverse().slice(0, 5);
            list.innerHTML = history.map(d => `
                <div onclick='showDetail(${JSON.stringify(d)})' class="flex items-center justify-between p-4 glass-card active:bg-white/5 transition-colors cursor-pointer">
                    <div class="flex items-center gap-3">
                        <div class="w-1.5 h-8 rounded-full ${d.Result==='WIN'?'bg-emerald-500':'bg-rose-500'}"></div>
                        <div>
                            <p class="font-bold text-slate-200">${d.Pair}</p>
                            <p class="text-[9px] text-slate-500 uppercase">${d.Position} ‚Ä¢ ${d.Date}</p>
                        </div>
                    </div>
                    <div class="text-right font-mono font-bold ${parseFloat(d['P/L ($)']) >= 0 ? 'text-emerald-400' : 'text-rose-400'}">
                        ${parseFloat(d['P/L ($)']) >= 0 ? '+' : ''}${parseFloat(d['P/L ($)']).toFixed(2)}
                        <i class="fa-solid fa-chevron-right text-[10px] ml-2 opacity-30"></i>
                    </div>
                </div>
            `).join('');
        }

        function showDetail(d) {
            document.getElementById('det-pair').innerText = `${d.Pair} (${d.Position})`;
            document.getElementById('det-id').innerText = d.ID;
            
            const checks = [
                {k:'H1 Trend', l:'‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡πå H1'},
                {k:'M15 Signal', l:'EMA M15'},
                {k:'ADX > 20', l:'‡πÅ‡∏£‡∏á‡∏™‡πà‡∏á ADX'}
            ];

            const checkHtml = checks.map(c => `
                <div class="flex items-center gap-2 text-[11px] ${d[c.k]==='Yes'?'text-emerald-400':'text-slate-500'}">
                    <i class="fa-solid ${d[c.k]==='Yes'?'fa-circle-check':'fa-circle-xmark'}"></i> ${c.l}
                </div>
            `).join('');

            const content = `
                <div class="detail-row"><span class="text-slate-500 text-xs">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span><span class="font-bold ${d.Result==='WIN'?'text-emerald-400':'text-rose-400'}">${d.Result}</span></div>
                <div class="detail-row"><span class="text-slate-500 text-xs">Lot Size</span><span class="font-bold">${d.Lot}</span></div>
                <div class="detail-row"><span class="text-slate-500 text-xs">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (Entry)</span><span class="font-mono text-sky-400">${d.Entry}</span></div>
                <div class="detail-row"><span class="text-slate-500 text-xs">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏¥‡∏î (Exit)</span><span class="font-mono text-amber-400">${d.Exit}</span></div>
                <div class="detail-row"><span class="text-slate-500 text-xs">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</span><span class="font-bold ${parseFloat(d['P/L ($)'])>=0?'text-emerald-400':'text-rose-400'}">$${d['P/L ($)']}</span></div>
                <div class="mt-4 pt-4 border-t border-white/5">
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-2">Checklist ‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πâ‡∏ô‡∏µ‡πâ</p>
                    <div class="grid grid-cols-3 gap-2">${checkHtml}</div>
                </div>
                <div class="mt-4 p-4 bg-slate-900/50 rounded-2xl">
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ï‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤: <span class="text-white">${d.Emotion || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'}</span></p>
                    <p class="text-xs text-slate-300 italic">"${d.Notes || '-'}"</p>
                </div>
                <div class="mt-2 p-4 bg-indigo-500/5 rounded-2xl border border-indigo-500/10">
                    <p class="text-[10px] font-bold text-indigo-400 uppercase mb-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πâ</p>
                    <p class="text-xs text-slate-300">"${d.Review || '-'}"</p>
                </div>
            `;
            document.getElementById('det-content').innerHTML = content;
            document.getElementById('modal-detail').classList.remove('hidden');
        }

        function closeDetail() { document.getElementById('modal-detail').classList.add('hidden'); }

        function openCloseModal(d) {
            document.getElementById('close-id').value = d.ID;
            const inputExit = document.getElementById('exit-price');
            inputExit.oninput = () => {
                const ex = parseFloat(inputExit.value); const en = parseFloat(d.Entry); const lot = parseFloat(d.Lot);
                if (isNaN(ex)) return;
                let diff = (d.Position === 'BUY') ? (ex - en) : (en - ex);
                let mult = d.Pair.includes('JPY') ? 1000 : (d.Pair.includes('XAU') ? 100 : 100000);
                let pl = (diff * lot * mult).toFixed(2);
                document.getElementById('pl-display').value = `$${pl}`;
                document.getElementById('pl-display').style.color = pl >= 0 ? '#10b981' : '#f43f5e';
                document.getElementById('close-result').value = pl >= 0 ? 'WIN' : 'LOSS';
            };
            document.getElementById('modal-close').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal-close').classList.add('hidden'); }

        function renderChart() {
            const ctx = document.getElementById('equityChart').getContext('2d');
            const closed = allData.filter(d => d.Result !== 'RUNNING');
            let bal = START_BALANCE; const points = [START_BALANCE]; const labels = ['0'];
            closed.forEach((d, i) => { bal += parseFloat(d['P/L ($)'] || 0); points.push(bal); labels.push((i+1).toString()); });
            if (equityChart) equityChart.destroy();
            equityChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ data: points, borderColor: '#38bdf8', borderWidth: 3, pointRadius: 0, fill: true, backgroundColor: 'rgba(56,189,248,0.1)', tension: 0.4 }] },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
            });
        }

        document.getElementById('recordForm').action = scriptURL;
        document.getElementById('closeForm').action = scriptURL;
        fetchData();
    </script>
</body>
</html>

